name: Marp Markdown to PDF Converter

on:
  workflow_dispatch:
    inputs:
      markdown_file:
        description: "MDãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ› (ä¾‹: sample-presentation.md)"
        required: true
        default: "sample-presentation.md"
      source_folder:
        description: "MDãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ãƒ•ã‚©ãƒ«ãƒ€"
        required: true
        default: "slides"
        type: choice
        options:
          - "slides"
          - "presentations"
          - "docs"
      output_folder:
        description: "PDFå‡ºåŠ›å…ˆãƒ•ã‚©ãƒ«ãƒ€"
        required: true
        default: "pdf"
        type: choice
        options:
          - "pdf"
          - "output"
          - "exports"
      css_theme:
        description: "CSSãƒ†ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«"
        required: true
        default: "default.css"
        type: choice
        options:
          - "default.css"
          - "corporate.css"
          - "minimal.css"
          - "dark.css"

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Create necessary directories
        run: |
          mkdir -p ${{ github.event.inputs.source_folder }}
          mkdir -p ${{ github.event.inputs.output_folder }}
          mkdir -p css

      - name: Check if markdown file exists
        run: |
          if [ ! -f "${{ github.event.inputs.source_folder }}/${{ github.event.inputs.markdown_file }}" ]; then
            echo "Error: ãƒ•ã‚¡ã‚¤ãƒ« ${{ github.event.inputs.source_folder }}/${{ github.event.inputs.markdown_file }} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚¡ã‚¤ãƒ«:"
            ls -la ${{ github.event.inputs.source_folder }}/ || echo "ãƒ•ã‚©ãƒ«ãƒ€ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
            exit 1
          fi

      - name: Check if CSS file exists
        run: |
          if [ ! -f "css/${{ github.event.inputs.css_theme }}" ]; then
            echo "Warning: CSSãƒ•ã‚¡ã‚¤ãƒ« css/${{ github.event.inputs.css_theme }} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’ä½¿ç”¨ã—ã¾ã™"
          fi

      - name: Convert MD to PDF
        run: |
          input_file="${{ github.event.inputs.source_folder }}/${{ github.event.inputs.markdown_file }}"
          filename=$(basename "${{ github.event.inputs.markdown_file }}")
          output_file="${{ github.event.inputs.output_folder }}/${filename%.*}.pdf"
          css_file="css/${{ github.event.inputs.css_theme }}"

          echo "å¤‰æ›é–‹å§‹: $input_file â†’ $output_file"

          # CSSãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [ -f "$css_file" ]; then
            echo "ã‚«ã‚¹ã‚¿ãƒ CSSã‚’ä½¿ç”¨: $css_file"
            marp "$input_file" --pdf --theme "$css_file" --output "$output_file"
          else
            echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒã‚’ä½¿ç”¨"
            marp "$input_file" --pdf --output "$output_file"
          fi

          echo "å¤‰æ›å®Œäº†: $output_file"

      - name: List generated files
        run: |
          echo "ç”Ÿæˆã•ã‚ŒãŸPDFãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la ${{ github.event.inputs.output_folder }}/

      - name: Upload PDF as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-pdf
          path: ${{ github.event.inputs.output_folder }}/*.pdf
          retention-days: 30

      - name: Commit and push generated PDF
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add ${{ github.event.inputs.output_folder }}/

          if git diff --cached --quiet; then
            echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          else
            git commit -m "ğŸ“„ Generated PDF from ${{ github.event.inputs.markdown_file }}"
            git push
            echo "PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          fi
